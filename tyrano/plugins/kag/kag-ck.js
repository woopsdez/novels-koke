tyrano.plugin.kag={tyrano:null,kag:null,sound_swf:null,cache_html:{},config:{defaultStorageExtension:"jpg",projectID:"tyranoproject",preload:"on"},define:{TYRANO_ENGINE_VERSION:.3,BASE_DIV_NAME:"tyrano_base",FLAG_APRI:!1,www:""},options:{modules:["order","parser","tag","layer","menu","tag_audio","tag_system","tag_ext","key_mouse"]},variable:{sf:{},tf:{}},tmp:{checking_macro:!1,num_anim:0,map_bgm:{},map_se:{}},stat:{map_label:{},map_macro:{},vertical:"false",f:{},mp:{},current_layer:"message0",current_page:"fore",is_stop:!1,is_strong_stop:!1,strong_stop_recover_index:0,is_nowait:!1,current_message_str:"ゲームスタート",current_keyframe:"",map_keyframe:{},is_script:!1,buff_script:"",is_html:!1,map_html:{},stack:{"if":[],call:[],macro:[]},set_text_span:!1,current_scenario:"first.ks",is_skip:{},current_bgm:"",current_line:0,is_hide_message:!1,is_click_text:!1,is_adding_text:!1,flag_ref_page:!1,ruby_str:"",ch_speed:30,flag_glyph:"false",current_cursor:"auto",font:{enable:!1,color:"",bold:"",size:"",face:""},locate:{x:0,y:0},default_font:{color:"",bold:"",size:""},chara_pos_mode:"true",chara_effect:"swing",chara_ptext:"",chara_time:"600",chara_memory:"false",chara_anim:"true",charas:{},play_bgm:!0,play_se:!0,title:""},init:function(){this.kag=this;var e=this;this.tyrano.test();this.parser.loadConfig(function(t){e.config=$.extend(!0,e.config,t);e.init_game()});$("script").each(function(){$(this).attr("src")&&($(this).attr("src").indexOf("cordova")!=-1||$(this).attr("src").indexOf("phonegap")!=-1)&&(e.define.FLAG_APRI=!0)});try{var t=$.getBrowser();if(t=="firefox"||t=="opera"||t=="safari"&&$.userenv()=="pc")$.isFlashInstalled()!=1?alert("FLASHがインストールされていないため、音楽が再生されません。"):this.kag.sound_swf=$.swfName("externalnovelsound")}catch(n){console.log(n)}},evalScript:function(str){var TG=this,f=this.stat.f,sf=this.variable.sf,tf=this.variable.tf,mp=this.stat.mp;eval(str);this.saveSystemVariable()},embScript:function(str,preexp){var f=this.stat.f,sf=this.variable.sf,tf=this.variable.tf,mp=this.stat.mp;return eval(str)},saveSystemVariable:function(){$.setStorage(this.kag.config.projectID+"_sf",this.variable.sf)},clearVariable:function(){this.stat.f={};this.variable.sf={};this.variable.tf={};this.saveSystemVariable()},pushStack:function(e,t){this.stat.stack[e].push(t)},popStack:function(e){return this.stat.stack[e].pop()},getStack:function(e){return this.stat.stack[e][this.stat.stack[e].length-1]},setStack:function(e,t){this.stat.stack[e][this.stat.stack[e].length-1]=t},endStorage:function(){var e=this.kag.getStack("call");if(e==null)return!1;this.kag.ftag.nextOrderWithIndex(e.index,e.storage);this.kag.popStack("call")},init_game:function(){var that=this;this.parser=object(tyrano.plugin.kag.parser);this.parser.kag=that;this.ftag=object(tyrano.plugin.kag.ftag);this.ftag.kag=that;this.ftag.init();this.layer=object(tyrano.plugin.kag.layer);this.layer.kag=that;this.layer.init();this.menu=object(tyrano.plugin.kag.menu);this.menu.kag=that;this.menu.init();var tmpsf=$.getStorage(this.kag.config.projectID+"_sf");tmpsf==null?this.variable.sf={}:this.variable.sf=eval("("+tmpsf+")");var auto_save_data=$.getStorage(this.kag.config.projectID+"_tyrano_auto_save");this.variable.sf.system={};auto_save_data?this.variable.sf.system.autosave=!0:this.variable.sf.system.autosave=!1;this.variable.tf.system={};this.variable.tf.system.backlog=[];var button_menu_obj=$("<div class='button_menu'><img src='./tyrano/images/kag/button_menu.png'  /></div>");if(this.kag.config.configLeft!="-1"&&this.kag.config.configTop!="-1"){button_menu_obj.css("left",parseInt(this.kag.config.configLeft));button_menu_obj.css("top",parseInt(this.kag.config.configTop))}else{button_menu_obj.css("left",this.config.scWidth-35);button_menu_obj.css("top",this.config.scHeight-35)}button_menu_obj.click(function(){that.menu.showMenu()});this.kag.config.configVisible=="false"&&button_menu_obj.hide();$("."+this.kag.define.BASE_DIV_NAME).append(button_menu_obj);this.tyrano.base.setBaseSize(this.config.scWidth,this.config.scHeight);this.tyrano.base.fitBaseSize(that.config.scWidth,that.config.scHeight);$(window).bind("load orientationchange resize",function(){if(Math.abs(window.orientation)===90){window.pageYOffset===0&&window.scrollTo(0,1);that.tyrano.base.fitBaseSize(that.config.scWidth,that.config.scHeight)}else{window.pageYOffset===0&&window.scrollTo(0,1);that.tyrano.base.fitBaseSize(that.config.scWidth,that.config.scHeight)}});this.layer.addLayer("base");this.layer.addLayer("message0");var j_message=$("<div class='message_outer'></div>");j_message.css("background-color",$.convertColor(this.config.frameColor)).css("opacity",$.convertOpacity(this.config.frameOpacity)).css("left",eval(this.config.ml)).css("top",eval(this.config.mt)).css("width",eval(this.config.mw)).css("height",eval(this.config.mh)).css("z-index",100);j_message.l_visible;this.layer.appendObj("message0","fore",j_message);var j_message_inner=$("<div class='message_inner' style='z-index:1001'></div>");this.config.defaultAutoReturn!="false"&&j_message_inner.css("word-break","break-all");this.layer.appendObj("message0","fore",j_message_inner);var num_message_layer=parseInt(this.config.numMessageLayers);for(var i=1;i<num_message_layer;i++){var message_layer_name="message"+i;this.layer.addLayer(message_layer_name);this.layer.getLayer(message_layer_name).attr("l_visible","false");this.layer.getLayer(message_layer_name).hide();var j_message1=j_message.clone(!1);this.layer.appendObj(message_layer_name,"fore",j_message1);var j_message_inner1=j_message_inner.clone(!1);this.layer.appendObj(message_layer_name,"fore",j_message_inner1)}this.layer.refMessageLayer();var fore_layer_num=parseInt(this.config.numCharacterLayers);for(var i=0;i<fore_layer_num;i++){this.layer.addLayer(""+i);this.layer.getLayer(""+i,"fore").css("display","none").css("z-index",10)}this.stat.default_font.color=$.convertColor(this.kag.config.defaultChColor);this.stat.default_font.bold=$.convertBold(this.kag.config.defaultBold);this.stat.default_font.size=this.kag.config.defaultFontSize;this.stat.vertical=this.kag.config.vertical;this.kag.stat.font=$.extend(!0,$.cloneObject(this.kag.stat.font),this.stat.default_font);this.setTitle(this.config["System.title"]);this.setCursor(this.config.cursorDefault);var first_scenario_file="first.ks";$("#first_scenario_file").size()>0&&(first_scenario_file=$("#first_scenario_file").val());this.loadScenario(first_scenario_file,function(e){that.ftag.buildTag(e)})},pushBackLog:function(e){var t=parseInt(this.kag.config.maxBackLogNum);if(t<1)return;this.variable.tf.system.backlog.push(e);t<this.variable.tf.system.backlog.length&&this.variable.tf.system.backlog.shift()},setTitle:function(e){this.stat.title=e;document.title=e},pushAnimStack:function(){this.kag.tmp.num_anim++},setCursor:function(e){this.stat.current_cursor=e;e==="default"?$("body").css("cursor","auto"):$("body").css("cursor","url(./data/image/"+e+"),default")},popAnimStack:function(){this.kag.tmp.num_anim>0&&this.kag.tmp.num_anim--;if(this.kag.tmp.num_anim<=0&&this.kag.stat.is_stop==1){this.kag.layer.showEventLayer();this.kag.ftag.nextOrder()}},loadScenario:function(e,t){var n=this;this.stat.current_scenario=e;var r="";$.isHTTP(e)?r=e:r="./data/scenario/"+e;$.loadText(r,function(e){var r=n.parser.parseScenario(e),i=r.array_s,s=r.map_label;n.stat.map_label=s;t&&t(i)})},getMessageInnerLayer:function(){return this.layer.getLayer(this.stat.current_layer,this.stat.current_page).find(".message_inner")},getMessageOuterLayer:function(){return this.layer.getLayer(this.stat.current_layer,this.stat.current_page).find(".message_outer")},getMessageCurrentSpan:function(){var e=this.layer.getLayer(this.stat.current_layer,this.stat.current_page).find(".message_inner").find("p").find(".current_span");return e},setMessageCurrentSpan:function(){var e=this.getMessageInnerLayer();e.find("p").length==0&&(this.stat.vertical=="true"?e.append($("<p class='vertical_text'></p>")):e.append($("<p class=''></p>")));if(e.find("p").find(".current_span").length>0){e.find("p").find(".current_span").removeClass("current_span");this.stat.set_text_span=!1}var t=$("<span class='current_span'></span>");e.find("p").append(t);return t},checkMessage:function(e){if(this.stat.set_text_span==1){e.find("p").find(".current_span").removeClass("current_span");this.stat.set_text_span=!1}e.find(".current_span").length==0&&e.find("p").append($("<span class='current_span'></span>"))},appendMessage:function(e,t){e.find("p").find(".current_span").html(t)},preload:function(e,t){var n=this;$("<img />").attr("src",e).load(function(e){t&&t()}).error(function(r){n.kag.error("画像ファイル「"+e+"」が見つかりません。場所はフルパスで指定されていますか？ (例)data/fgimage/file.png");t&&t()})},setStyles:function(e,t){for(key in t)t[key]&&t[key]!=""&&e.css(key,t[key]);return e},html:function(e,t,n){var r=this;t=t||{};if(this.cache_html[e]&&n){var i=$.templates(this.cache_html[e]),s=i.render(t);n($(s))}$.loadText("./tyrano/html/"+e+".html",function(i){var s=$.templates(i),o=s.render(t);r.cache_html[e]=i;n&&n($(o))})},error:function(e){if(this.kag.config["debugMenu.visible"]=="true")var t=this.kag.stat.current_scenario,n=parseInt(this.kag.stat.current_line)+1,r="Error:"+t+":"+n+"行目:"+e},warning:function(e){this.kag.config["debugMenu.visible"]=="true"&&alert(e)},log:function(e){this.kag.config["debugMenu.visible"]=="true"&&console.log(e)},test:function(){}};tyrano.plugin.kag.tag={};