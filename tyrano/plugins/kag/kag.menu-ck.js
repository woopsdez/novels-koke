tyrano.plugin.kag.menu={tyrano:null,kag:null,snap:null,init:function(){},showMenu:function(e){if(this.kag.layer.layer_event.css("display")=="none")return!1;if(this.kag.stat.is_strong_stop==1)return!1;var t=this;this.kag.stat.is_skip=!1;var n=this.kag.layer.getMenuLayer();n.empty();this.kag.html("menu",{},function(e){var r=$(e);n.append(r);n.find(".menu_skip").click(function(){n.html("");n.hide();$(".button_menu").show();t.kag.stat.is_skip=!0;t.kag.layer.layer_event.css("display")!="none"&&t.kag.ftag.nextOrder()});n.find(".menu_close").click(function(e){n.hide();$(".button_menu").show()});n.find(".menu_window_close").click(function(e){t.kag.layer.hideMessageLayers();n.hide();$(".button_menu").show()});n.find(".menu_save").click(function(e){t.displaySave()});n.find(".menu_load").click(function(e){t.displayLoad()});n.find(".menu_back_title").click(function(){if(!confirm("タイトルに戻ります。よろしいですね？"))return!1;location.reload()});n.show();$(".button_menu").hide()})},displaySave:function(){var e=this;this.kag.stat.is_skip=!1;var t=e.getSaveData(),n=t.data,r=e.kag.layer.getMenuLayer();for(var i=0;i<n.length;i++)n[i].num=i;this.kag.html("save",{array_save:n},function(t){var n=$(t);n.find(".save_display_area").each(function(){$(this).click(function(t){var n=$(this).attr("data-num");e.snap=null;e.doSave(n);var r=e.kag.layer.getMenuLayer();r.hide();r.empty();$(".button_menu").show()})});var r=e.kag.layer.getMenuLayer();e.setMenu(n)})},doSave:function(e){var t=this.getSaveData(),n={},r=this;this.snap==null&&this.snapSave(this.kag.stat.current_message_str,function(){if(r.snap.stat.is_strong_stop==1){alert("ここではセーブできません");return!1}n=r.snap;n.save_date=$.getNowDate()+"　"+$.getNowTime();t.data[e]=n;$.setStorage(r.kag.config.projectID+"_tyrano_data",t)})},doSetAutoSave:function(){var e=this.snap;e.save_date=$.getNowDate()+"　"+$.getNowTime();$.setStorage(this.kag.config.projectID+"_tyrano_auto_save",e)},loadAutoSave:function(){var data=$.getStorage(this.kag.config.projectID+"_tyrano_auto_save");if(!data)return!1;data=eval("("+data+")");this.loadGameData($.extend(!0,{},data))},snapSave:function(e,t){var n=this,r=n.kag.ftag.current_order_index,i=$.extend(!0,{},$.cloneObject(n.kag.stat));if(this.kag.config.configThumbnail=="false"){var s="",o={};o.title=e;o.stat=i;o.current_order_index=r-1;o.save_date=$.getNowDate()+"　"+$.getNowTime();o.img_data=s;var u=n.kag.layer.getLayeyHtml();o.layer=u;n.snap=$.extend(!0,{},$.cloneObject(o));t&&t()}else html2canvas($("#tyrano_base").get(0),{onrendered:function(s){var o=s.toDataURL(),u={};u.title=e;u.stat=i;u.current_order_index=r-1;u.save_date=$.getNowDate()+"　"+$.getNowTime();u.img_data=o;var a=n.kag.layer.getLayeyHtml();u.layer=a;n.snap=$.extend(!0,{},$.cloneObject(u));t&&t()}})},displayLoad:function(){var e=this;this.kag.stat.is_skip=!1;var t=e.getSaveData(),n=t.data,r=e.kag.layer.getMenuLayer();for(var i=0;i<n.length;i++)n[i].num=i;this.kag.html("load",{array_save:n},function(t){var n=$(t);n.find(".save_display_area").each(function(){$(this).click(function(t){var n=$(this).attr("data-num");e.snap=null;e.loadGame(n);var r=e.kag.layer.getMenuLayer();r.hide();r.empty();$(".button_menu").show()})});var r=e.kag.layer.getMenuLayer();e.setMenu(n)})},loadGame:function(e){var t=this.getSaveData(),n=t.data;this.loadGameData($.extend(!0,{},n[e]))},loadGameData:function(e){var t="yes";this.kag.layer.setLayerHtml(e.layer);this.kag.stat=e.stat;this.kag.stat.is_strong_stop=!1;this.kag.ftag.startTag("stopbgm",{stop:"true"});this.kag.ftag.startTag("stopse",{stop:"true"});if(this.kag.stat.current_bgm!=""){var n=this.kag.stat.current_bgm,r={loop:"true",storage:n,stop:"true"};this.kag.ftag.startTag("playbgm",r)}this.kag.setCursor(this.kag.stat.current_cursor);var i={name:"call",pm:{storage:"make.ks"},val:""};this.kag.ftag.nextOrderWithIndex(e.current_order_index,e.stat.current_scenario,!0,i,t)},setMenu:function(e){var t=this,n=this.kag.layer.getMenuLayer();n.empty();var r="<div class='menu_item menu_close' style='float:right;'><img src='tyrano/images/kag/menu_button_close.png' /></div><div style='clear:both'></div>",i=$(r);n.append(i);n.find(".menu_close").click(function(e){n.hide();$(".button_menu").show()});n.append(e);n.show()},hideMenu:function(){},getSaveData:function(){var tmp_array=$.getStorage(this.kag.config.projectID+"_tyrano_data");if(tmp_array)return eval("("+tmp_array+")");tmp_array=new Array;var root={kind:"save"};for(var i=0;i<5;i++){var json={};json.title="まだ、保存されているデータがありません";json.current_order_index=0;json.save_date="　";json.img_data="";json.stat={};tmp_array.push(json)}root.data=tmp_array;return root},displayLog:function(){var e=this;this.kag.stat.is_skip=!1;var t=$("<div></div>");this.kag.html("backlog",{},function(t){var n=$(t),r=e.kag.layer.getMenuLayer();r.empty();r.append(n);r.find(".menu_close").click(function(){r.hide();$(".button_menu").show()});var i="",s=e.kag.variable.tf.system.backlog;for(var o=0;o<s.length;o++)i+=s[o]+"<br />";r.find(".log_body").html(i);r.show();r.find(".log_body").scrollTop(9999999999);$(".button_menu").hide()})},test:function(){}};